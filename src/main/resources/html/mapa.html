<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mapa Interactivo</title>

    <!-- Leaflet 1.7.1 (compatible con JavaFX WebView) -->
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
        }
        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
<div id="map"></div>

<!-- Leaflet JS compatible -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
    // Inicialización del mapa centrado en Bogotá
    var map = L.map('map', {
        preferCanvas: true       // MÁS RÁPIDO en WebView
    }).setView([4.6097, -74.0817], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Capas
    var marcadoresLayer = L.layerGroup().addTo(map);
    var rutasLayer = L.layerGroup().addTo(map);
    var caminoLayer = L.layerGroup().addTo(map);

    // Arreglos
    var ubicaciones = [];
    var rutas = [];

    // ----------- FUNCIONES PÚBLICAS (Java puede llamarlas) ---------------- //

    /** Agrega un marcador avanzado con popup */
    function agregarMarcadorAvanzado(lat, lon, nombre, popupHTML, color) {
        var marker = L.circleMarker([lat, lon], {
            color: color,
            radius: 8,
            fillOpacity: 0.8
        }).bindPopup(popupHTML);

        marcadoresLayer.addLayer(marker);

        ubicaciones.push({lat: lat, lon: lon, nombre: nombre, urgencia: color});
    }

    /** Agrega una ruta entre dos puntos */
    function agregarRuta(lat1, lon1, lat2, lon2) {
        var ruta = L.polyline([[lat1, lon1], [lat2, lon2]], {
            color: "green",
            weight: 3
        });

        rutasLayer.addLayer(ruta);
        rutas.push([[lat1, lon1], [lat2, lon2]]);
    }

    /** Mostrar camino más corto */
    function mostrarCaminoMasCorto(coordsArray, color='red') {
        limpiarCaminos();
        if (coordsArray.length === 0) return;

        caminoLayer = L.layerGroup().addTo(map);

        var poly = L.polyline(coordsArray, {
            color: color,
            weight: 5
        });

        caminoLayer.addLayer(poly);
    }

    /** Limpiar camino */
    function limpiarCaminos() {
        caminoLayer.clearLayers();
    }

    /** Centrar mapa */
    function centrarEn(lat, lon) {
        map.setView([lat, lon], 14);
    }

</script>
</body>
</html>
